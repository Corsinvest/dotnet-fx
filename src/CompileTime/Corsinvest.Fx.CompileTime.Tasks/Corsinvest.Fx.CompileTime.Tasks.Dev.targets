<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Use net9.0 for development (best compatibility with Visual Studio MSBuild) -->
    <!-- Ensure proper path resolution for development builds -->
    <CompileTimeTasksAssembly>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)bin\$(Configuration)\net9.0\Corsinvest.Fx.CompileTime.Tasks.dll'))</CompileTimeTasksAssembly>
    <CompileTimeGeneratorPath>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\Corsinvest.Fx.CompileTime.Generator\bin\$(Configuration)\net9.0\Corsinvest.Fx.CompileTime.Generator.exe'))</CompileTimeGeneratorPath>
  </PropertyGroup>

  <UsingTask TaskName="Corsinvest.Fx.CompileTime.Tasks.CompileTimeTask"
             AssemblyFile="$(CompileTimeTasksAssembly)"
             Runtime="Net"
             Condition="Exists('$(CompileTimeTasksAssembly)')" />

  <Target Name="CompileTimeExecution"
          BeforeTargets="CoreCompile"
          Condition="'$(CompileTimeEnabled)' == 'true' and '@(Compile)' != '' and '$(CompileTimeTasksAssembly)' != '' and Exists('$(CompileTimeTasksAssembly)')">

    <MakeDir Directories="$(IntermediateOutputPath)CompileTime\" />

    <CompileTimeTask
      SourceFiles="@(Compile)"
      ProjectDir="$(MSBuildProjectDirectory)"
      GeneratorAssemblyPath="$(CompileTimeGeneratorPath)"
      References="@(ReferencePath)"
      OutputPath="$(IntermediateOutputPath)CompileTime"
      TimeoutMs="$(CompileTimeTimeout)"
      TimeoutBehavior="$(CompileTimeBehaviorOnTimeout)"
      CompileTimeEnabled="$(CompileTimeEnabled)"
      GenerateReport="$(CompileTimeReport)"
      DebugMode="$(CompileTimeDebugMode)">
      <Output TaskParameter="GeneratedFiles" ItemName="Compile" />
      <Output TaskParameter="GeneratedFiles" ItemName="FileWrites" />
    </CompileTimeTask>


  </Target>

</Project>
